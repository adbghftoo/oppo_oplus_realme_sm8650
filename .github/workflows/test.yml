name: Google GKI 6.1 é€šç”¨å†…æ ¸æ„å»º

env:
  TZ: Asia/Shanghai
  ANDROID_VERSION: 'android14'
  KERNEL_VERSION: '6.1'
  # æŒ‡å®š GKI åˆ†æ”¯ï¼Œandroid14-6.1 æ˜¯ç›®å‰æœ€ä¸»æµçš„ GKI åˆ†æ”¯
  GKI_BRANCH: 'android14-6.1'

on:
  workflow_dispatch:
    inputs:
      ksu_type:
        description: 'KernelSUåˆ†æ”¯(SukiSU Ultra/KernelSU Next/MKSU/KernelSU(åŸç‰ˆ),é»˜è®¤SukiSU Ultra)'
        required: true
        type: choice
        default: 'sukisu'
        options:
          - 'sukisu'
          - 'ksunext'
          - 'mksu'
          - 'ksu'
      susfs_enable:
        description: 'æ˜¯å¦å¼€å¯susfs(ç”¨äºå¢å¼ºéšè—ç¯å¢ƒæŒ‚è½½åŠŸèƒ½; éœ€è¦é…å¥—æ¨¡å—)'
        required: true
        type: boolean
        default: 'true'
      kpm_enable:
        description: 'æ˜¯å¦å¼€å¯kpm(ä»…å¯¹sukisuç”Ÿæ•ˆ; å¢å¼ºæ¨¡å—æ”¯æŒ)'
        required: true
        type: boolean
        default: 'false'
      lz4_enable:
        description: 'æ˜¯å¦å¯ç”¨ ZRAM lz4/zstd å‹ç¼©ç®—æ³•è¡¥ä¸'
        required: true
        type: boolean
        default: 'true'
      lz4kd_enable:
        description: 'æ˜¯å¦å®‰è£… LZ4KD è¡¥ä¸(é«˜æ€§èƒ½è§£å‹)'
        required: true
        type: boolean
        default: 'false'
      bbr_enable:
        description: 'æ˜¯å¦å¯ç”¨BBR/Brutalæ‹¥å¡æ§åˆ¶ç®—æ³•'
        required: true
        type: choice
        default: 'false'
        options:
          - 'false'
          - 'true'
          - 'default'
      better_net:
        description: 'æ˜¯å¦å¼€å¯ç½‘ç»œåŠŸèƒ½æ‹“å±•(Netfilter/IPSet/TTLç­‰)'
        required: true
        type: boolean
        default: 'true'
      kernel_suffix:
        description: 'å†…æ ¸åç¼€(å¯é€‰)'
        required: false
        type: string
        default: 'GKI'

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      ksuver: ${{ steps.ksu_version.outputs.ksuver }}
    steps:
      - name: å®‰è£…ç¯å¢ƒä¾èµ–
        run: |
          rm -rf kernel_workspace
          mkdir kernel_workspace
          cd kernel_workspace
          
          sudo apt-mark hold firefox &&
          sudo apt-mark hold libc-bin &&
          sudo apt purge man-db &&
          sudo apt update &&
          sudo apt-get install -y --no-install-recommends binutils python-is-python3 libssl-dev libelf-dev ccache git make bc bison flex
          
          echo "æ­£åœ¨å…‹éš† Google GKI æºç  (Android 14 - 6.1)..."
          # ä½¿ç”¨ Google å®˜æ–¹æºç æˆ–è€…å›½å†…é•œåƒï¼Œè¿™é‡Œä½¿ç”¨ GitHub é•œåƒåŠ é€Ÿä¸‹è½½
          git clone --depth=1 https://github.com/kernel-toast/android_kernel_common -b ${{ env.GKI_BRANCH }} common
          
          echo "æ­£åœ¨ä¸‹è½½ Google Clang å·¥å…·é“¾..."
          mkdir clang
          # ä¸‹è½½é€‚åˆ GKI 6.1 çš„ Clang ç‰ˆæœ¬ (r487747c æ˜¯ Android 14 å¸¸ç”¨ç‰ˆæœ¬)
          wget -q https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/heads/master/clang-r487747c.tar.gz
          tar -xf clang-r487747c.tar.gz -C clang/
          rm clang-r487747c.tar.gz

          echo "ç¯å¢ƒå‡†å¤‡å®Œæˆ"
          
          # å»é™¤ dirty åç¼€
          cd common
          for f in scripts/setlocalversion; do
            sed -i 's/ -dirty//g' "$f"
          done

      - name: é…ç½®ccacheç›®å½•
        run: |
          echo "CCACHE_DIR=$HOME/.ccache_gki" >> $GITHUB_ENV
          echo "CCACHE_MAXSIZE=3G" >> $GITHUB_ENV

      - name: è½½å…¥ccacheç¼“å­˜
        uses: actions/cache@v4
        with:
          path: ${{ env.CCACHE_DIR }}
          key: ccache-gki-${{ env.KERNEL_VERSION }}-${{ runner.os }}
          restore-keys: |
            ccache-gki-${{ env.KERNEL_VERSION }}-
      
      - name: åˆå§‹åŒ–ccache
        run: |
          export CCACHE_COMPILERCHECK="none"
          export CCACHE_BASEDIR="${{ github.workspace }}"
          export CCACHE_NOHASHDIR="true"
          export CCACHE_HARDLINK="true"
          mkdir -p "${{ env.CCACHE_DIR }}"
          ccache -M "${{ env.CCACHE_MAXSIZE }}"
          ccache -o compression=true
          ccache -s

      - name: æ·»åŠ  KernelSU
        id: ksu_version
        run: |
          cd kernel_workspace/common
          # é’ˆå¯¹ GKIï¼Œç›´æ¥åœ¨æºç æ ¹ç›®å½•æ‰§è¡Œ
          if [[ ${{ github.event.inputs.ksu_type }} == "sukisu" ]]; then
            echo "æ­£åœ¨é…ç½® SukiSU Ultra..."
            curl -LSs "https://raw.githubusercontent.com/ShirkNeko/SukiSU-Ultra/refs/heads/main/kernel/setup.sh" | bash -s tmp-builtin
            # è·å–ç‰ˆæœ¬é€»è¾‘ä¿æŒä¸å˜ï¼Œç¡®ä¿ env æ­£ç¡®
            cd KernelSU
            KSU_VERSION=$(expr $(git rev-list --count main) + 37185 2>/dev/null || echo 114514)
            echo "KSUVER=$KSU_VERSION" >> $GITHUB_ENV
            echo "ksuver=$KSU_VERSION" >> $GITHUB_OUTPUT
          elif [[ ${{ github.event.inputs.ksu_type }} == "ksunext" ]]; then
            echo "æ­£åœ¨é…ç½® KernelSU Next..."
            curl -LSs "https://raw.githubusercontent.com/pershoot/KernelSU-Next/next-susfs/kernel/setup.sh" | bash -s next-susfs
            cd KernelSU-Next
            KSU_VERSION=$(expr $(curl -sI "https://api.github.com/repos/pershoot/KernelSU-Next/commits?sha=stable&per_page=1" | grep -i "link:" | sed -n 's/.*page=\([0-9]*\)>; rel="last".*/\1/p') "+" 10200)
            echo "KSUVER=$KSU_VERSION" >> $GITHUB_ENV
            echo "ksuver=$KSU_VERSION" >> $GITHUB_OUTPUT
          elif [[ ${{ github.event.inputs.ksu_type }} == "mksu" ]]; then
             echo "æ­£åœ¨é…ç½® MKSU..."
             curl -LSs "https://raw.githubusercontent.com/5ec1cff/KernelSU/refs/heads/main/kernel/setup.sh" | bash -s main
             cd KernelSU
             KSU_VERSION=$(expr $(curl -sI "https://api.github.com/repos/5ec1cff/KernelSU/commits?sha=main&per_page=1" | grep -i "link:" | sed -n 's/.*page=\([0-9]*\)>; rel="last".*/\1/p') "+" 30000)
             echo "KSUVER=$KSU_VERSION" >> $GITHUB_ENV
             echo "ksuver=$KSU_VERSION" >> $GITHUB_OUTPUT
          else
             echo "æ­£åœ¨é…ç½®åŸç‰ˆ KernelSU..."
             curl -LSs "https://raw.githubusercontent.com/tiann/KernelSU/refs/heads/main/kernel/setup.sh" | bash -s main
             cd KernelSU
             KSU_VERSION=$(expr $(curl -sI "https://api.github.com/repos/tiann/KernelSU/commits?sha=main&per_page=1" | grep -i "link:" | sed -n 's/.*page=\([0-9]*\)>; rel="last".*/\1/p') "+" 30000)
             echo "KSUVER=$KSU_VERSION" >> $GITHUB_ENV
             echo "ksuver=$KSU_VERSION" >> $GITHUB_OUTPUT
          fi

      - name: åº”ç”¨ SUSFS è¡¥ä¸
        if: inputs.susfs_enable
        run: |
          cd kernel_workspace/common
          echo "æ­£åœ¨ä¸‹è½½ SUSFS è¡¥ä¸..."
          git clone --depth=1 https://gitlab.com/simonpunk/susfs4ksu.git -b gki-${{ env.ANDROID_VERSION }}-${{ env.KERNEL_VERSION }}
          
          # å¤åˆ¶ generic GKI è¡¥ä¸
          cp ./susfs4ksu/kernel_patches/50_add_susfs_in_gki-${{ env.ANDROID_VERSION }}-${{ env.KERNEL_VERSION }}.patch ./
          cp ./susfs4ksu/kernel_patches/fs/* ./fs/
          cp ./susfs4ksu/kernel_patches/include/linux/* ./include/linux/
          
          # åº”ç”¨è¡¥ä¸
          patch -p1 < 50_add_susfs_in_gki-${{ env.ANDROID_VERSION }}-${{ env.KERNEL_VERSION }}.patch || true
          
          # KSU ä¾§çš„è¡¥ä¸ (ä»…é sukisu/next éœ€è¦æ‰‹åŠ¨æ‰“éƒ¨åˆ†è¡¥ä¸ï¼Œè¿™é‡Œç®€åŒ–å¤„ç†)
          if [[ -d "KernelSU" ]]; then
             cp ./susfs4ksu/kernel_patches/KernelSU/10_enable_susfs_for_ksu.patch ./KernelSU/
             cd KernelSU
             patch -p1 < 10_enable_susfs_for_ksu.patch || true
             cd ..
          fi

      - name: åº”ç”¨ Lz4/Zstd è¡¥ä¸
        if: inputs.lz4_enable
        run: |
          cd kernel_workspace/common
          echo "åº”ç”¨å‹ç¼©ç®—æ³•è¡¥ä¸..."
          # ä½¿ç”¨é€šç”¨çš„è¡¥ä¸æº
          wget https://github.com/cctv18/oppo_oplus_realme_sm8650/raw/refs/heads/main/zram_patch/001-lz4.patch
          wget https://github.com/cctv18/oppo_oplus_realme_sm8650/raw/refs/heads/main/zram_patch/002-zstd.patch
          # å°è¯•åº”ç”¨
          git apply -p1 < 001-lz4.patch || true
          patch -p1 < 002-zstd.patch || true

      - name: é…ç½® GKI å‚æ•°
        run: |
          cd kernel_workspace/common
          # ä½¿ç”¨ GKI é»˜è®¤é…ç½®
          CONF="arch/arm64/configs/gki_defconfig"
          
          echo "CONFIG_KSU=y" >> $CONF
          
          if [[ "${{ github.event.inputs.susfs_enable }}" == "true" ]]; then
            echo "CONFIG_KSU_SUSFS=y" >> $CONF
            echo "CONFIG_KSU_SUSFS_HAS_MAGIC_MOUNT=y" >> $CONF
            echo "CONFIG_KSU_SUSFS_SUS_PATH=y" >> $CONF
            echo "CONFIG_KSU_SUSFS_SUS_MOUNT=y" >> $CONF
            echo "CONFIG_KSU_SUSFS_AUTO_ADD_SUS_KSU_DEFAULT_MOUNT=y" >> $CONF
            echo "CONFIG_KSU_SUSFS_AUTO_ADD_SUS_BIND_MOUNT=y" >> $CONF
            echo "CONFIG_KSU_SUSFS_SUS_KSTAT=y" >> $CONF
            echo "CONFIG_KSU_SUSFS_TRY_UMOUNT=y" >> $CONF
            echo "CONFIG_KSU_SUSFS_SPOOF_UNAME=y" >> $CONF
            echo "CONFIG_KSU_SUSFS_ENABLE_LOG=y" >> $CONF
            echo "CONFIG_KSU_SUSFS_HIDE_KSU_SUSFS_SYMBOLS=y" >> $CONF
            echo "CONFIG_KSU_SUSFS_SPOOF_CMDLINE_OR_BOOTCONFIG=y" >> $CONF
            echo "CONFIG_KSU_SUSFS_OPEN_REDIRECT=y" >> $CONF
            echo "CONFIG_KSU_SUSFS_SUS_MAP=y" >> $CONF
          fi
          
          # Mountify æ”¯æŒ
          echo "CONFIG_TMPFS_XATTR=y" >> $CONF
          echo "CONFIG_TMPFS_POSIX_ACL=y" >> $CONF
          
          # ç½‘ç»œå¢å¼º
          if [[ "${{ github.event.inputs.better_net }}" == "true" ]]; then
            echo "CONFIG_BPF_STREAM_PARSER=y" >> $CONF
            echo "CONFIG_NETFILTER_XT_MATCH_ADDRTYPE=y" >> $CONF
            echo "CONFIG_NETFILTER_XT_SET=y" >> $CONF
            echo "CONFIG_IP_SET=y" >> $CONF
            echo "CONFIG_IP_SET_MAX=65534" >> $CONF
            echo "CONFIG_IP6_NF_NAT=y" >> $CONF
            echo "CONFIG_IP6_NF_TARGET_MASQUERADE=y" >> $CONF
          fi
          
          # BBR
          if [[ "${{ github.event.inputs.bbr_enable }}" != "false" ]]; then
            echo "CONFIG_TCP_CONG_ADVANCED=y" >> $CONF
            echo "CONFIG_TCP_CONG_BBR=y" >> $CONF
            echo "CONFIG_TCP_CONG_CUBIC=y" >> $CONF
            echo "CONFIG_TCP_CONG_BRUTAL=y" >> $CONF
            if [[ "${{ github.event.inputs.bbr_enable }}" == "default" ]]; then
              echo "CONFIG_DEFAULT_TCP_CONG=bbr" >> $CONF
            fi
          fi

          # ç¦ç”¨æ¨¡å—ç­¾åæ£€æŸ¥ä»¥å…è®¸åŠ è½½æœªç­¾åæ¨¡å—ï¼ˆå¯é€‰ï¼ŒGKI é€šå¸¸ä¸éœ€è¦ä¸¥æ ¼ç­¾åå¦‚æœç¦ç”¨äº†æ£€æŸ¥ï¼‰
          echo "CONFIG_MODULE_SIG=n" >> $CONF
          
      - name: æ„å»ºå†…æ ¸
        run: |
          cd kernel_workspace/common
          
          # è®¾ç½®ç¯å¢ƒå˜é‡
          export PATH="$GITHUB_WORKSPACE/kernel_workspace/clang/bin:$PATH"
          export ARCH=arm64
          export SUBARCH=arm64
          export CROSS_COMPILE=aarch64-linux-gnu-
          export CROSS_COMPILE_COMPAT=arm-linux-gnueabi-
          export CC="ccache clang"
          export LD=ld.lld
          
          # è¾“å‡ºç‰ˆæœ¬ä¿¡æ¯
          clang --version
          
          # ç”Ÿæˆé…ç½®
          make O=out gki_defconfig
          
          # å¼€å§‹ç¼–è¯‘
          # GKI æ„å»ºé€šå¸¸ä¼šç”Ÿæˆ Image å’Œ Image.lz4
          make -j$(nproc) O=out LLVM=1 LLVM_IAS=1 Image Image.lz4
          
          echo "å†…æ ¸ç¼–è¯‘å®Œæˆï¼"
          ls -lh out/arch/arm64/boot/Image
          
      - name: åº”ç”¨ KPM (Sukisu Only)
        if: inputs.kpm_enable && inputs.ksu_type == 'sukisu'
        run: |
          cd kernel_workspace/common/out/arch/arm64/boot
          echo "åº”ç”¨ KPM è¡¥ä¸..."
          curl -LO https://github.com/SukiSU-Ultra/SukiSU_KernelPatch_patch/releases/download/0.12.2/patch_linux
          chmod +x patch_linux
          ./patch_linux
          rm -f Image
          mv oImage Image

      - name: æ‰“åŒ… AnyKernel3
        run: |
          cd kernel_workspace
          git clone https://github.com/cctv18/AnyKernel3 --depth=1
          rm -rf ./AnyKernel3/.git
          cd AnyKernel3
          
          # å¤åˆ¶å†…æ ¸é•œåƒ
          cp ../common/out/arch/arm64/boot/Image ./
          
          # ä¿®æ”¹ anykernel.sh ä»¥é€‚é… Generic
          sed -i 's/do.devicecheck=1/do.devicecheck=0/g' anykernel.sh
          
          # ç¡®å®šåç§°å˜é‡
          if [[ ${{ github.event.inputs.ksu_type }} == "sukisu" ]]; then
            KSU_TYPE="SukiSU"
          else
            KSU_TYPE="KSU"
          fi
          
          SUFFIX="${{ github.event.inputs.kernel_suffix }}"
          ZIP_NAME="GKI6.1_${KSU_TYPE}_${{ env.KSUVER }}_${SUFFIX}.zip"
          
          zip -r "../$ZIP_NAME" ./*
          echo "ZIP_NAME=$ZIP_NAME" >> $GITHUB_ENV

      - name: ä¸Šä¼ å·¥ä»¶
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ZIP_NAME }}
          path: kernel_workspace/${{ env.ZIP_NAME }}

  release:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: ä¸‹è½½å·¥ä»¶
        uses: actions/download-artifact@v4
        with:
          path: ./release_files
          merge-multiple: true

      - name: åˆ›å»º Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: "GKI-6.1-${{ env.TZ }}-${{ github.run_id }}"
          name: "Google GKI 6.1 Kernel (${{ inputs.ksu_type }})"
          body: |
            ### ğŸ§ Google GKI 6.1 é€šç”¨å†…æ ¸æ„å»º
            
            **æ„å»ºä¿¡æ¯ï¼š**
            - **å†…æ ¸æºç **: Android Common Kernel (android14-6.1)
            - **KernelSUåˆ†æ”¯**: ${{ inputs.ksu_type }}
            - **SUSFS**: ${{ inputs.susfs_enable }}
            - **Lz4/Zstd**: ${{ inputs.lz4_enable }}
            - **BBR**: ${{ inputs.bbr_enable }}
            
            **é€‚ç”¨è®¾å¤‡ï¼š**
            - æ”¯æŒ GKI 2.0 ä¸”å†…æ ¸ç‰ˆæœ¬ä¸º 6.1 çš„ Android è®¾å¤‡ï¼ˆå¦‚éªé¾™ 8Gen3 æœºå‹ï¼‰ã€‚
            
            **åˆ·å…¥æ–¹æ³•ï¼š**
            - ä½¿ç”¨ KernelFlasherã€Franco Kernel Manager æˆ– TWRP åˆ·å…¥ zip åŒ…ã€‚
            - **æ³¨æ„**ï¼šåˆ·å…¥å‰è¯·åŠ¡å¿…å¤‡ä»½åŸç‰ˆ boot.imgï¼ŒGKI åˆ·å†™æœ‰é£é™©ã€‚
            
          files: |
            release_files/*.zip
