name: 加速版构建 Google 通用 GKI 6.1.118 内核
env:
  TZ: Asia/Shanghai
  ANDROID_VERSION: 'android14'
  KERNEL_VERSION: '6.1'
  KERNEL_NAME: 'android14-6.1-gki'
on:
  workflow_dispatch:
    inputs:
      ksu_type:
        description: 'KernelSU分支(SukiSU Ultra/KernelSU Next/MKSU/KernelSU(原版),默认SukiSU Ultra)'
        required: true
        type: choice
        default: 'sukisu'
        options:
          - 'sukisu'
          - 'ksunext'
          - 'mksu'
          - 'ksu'
      susfs_enable:
        description: '是否开启susfs(用于增强隐藏环境挂载功能; 可能轻微增加耗电，上游更新导致不稳定时或不需要可关闭)'
        required: true
        type: boolean
        default: 'true'
      kpm_enable:
        description: '是否开启kpm(仅对sukisu生效; 可能轻微增加耗电，不需要可保持默认关闭)'
        required: true
        type: boolean
        default: 'false'
      lz4_enable:
        description: '是否安装 lz4 1.10.0+zstd 1.5.7 补丁及 LZ4KD 补丁'
        required: true
        type: boolean
        default: 'true'
      lz4kd_enable:
        description: '是否安装 LZ4KD 补丁(若已开启lz4+zstd补丁则可不开启)'
        required: true
        type: boolean
        default: 'false'
      bbr_enable:
        description: '是否启用bbr算法(优化上行数据,对手机日用无太大意义甚至可能负优化;false关闭,true仅加入算法,default设为默认)'
        required: true
        type: choice
        default: 'false'
        options:
          - 'false'
          - 'true'
          - 'default'
      better_net:
        description: '是否开启网络功能拓展配置(用于为ipset及需要iptables等高级网络功能内核支持的程序提供支持)'
        required: true
        type: boolean
        default: 'true'
      ccache_debug:
        description: '是否上传 Ccache调试日志(用于调试, 无需要不必开启)'
        required: true
        type: boolean
        default: 'false'
      kernel_suffix:
        description: '内核后缀(留空默认,开头别加连字符,勿加空格等影响指令运行的保留字符)'
        required: false
        type: string
        default: ''

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      ksuver: ${{ steps.ksu_version.outputs.ksuver }}
    steps:
      - name: 安装环境依赖+初始化源码仓库及llvm-Clang20工具链
        run: |
          rm -rf kernel_workspace
          mkdir kernel_workspace
          cd kernel_workspace
         
          sudo apt-mark hold firefox &&
          sudo apt-mark hold libc-bin &&
          sudo apt purge man-db &&
          sudo rm -rf /var/lib/man-db/auto-update &&
          sudo apt update &&
          sudo apt-get install -y --no-install-recommends binutils python-is-python3 libssl-dev libelf-dev ccache dwarves pahole &
         
          echo "正在克隆 Google 官方 GKI 通用内核源码 (android14-6.1)..."
          git clone --depth=1 https://android.googlesource.com/kernel/common -b android14-6.1
          mv common gki_common
         
          echo "正在克隆llvm-Clang20工具链..." &&
          mkdir -p clang20 &&
          aria2c -s16 -x16 -k1M https://github.com/cctv18/oneplus_sm8650_toolchain/releases/download/LLVM-Clang20-r547379/clang-r547379.zip -o clang.zip &&
          unzip -q clang.zip -d clang20 &&
          rm -rf clang.zip &
         
          echo "正在克隆构建工具..." &&
          aria2c -s16 -x16 -k1M https://github.com/cctv18/oneplus_sm8650_toolchain/releases/download/LLVM-Clang20-r547379/build-tools.zip -o build-tools.zip &&
          unzip -q build-tools.zip &&
          rm -rf build-tools.zip &
         
          wait
          echo "所有源码及llvm-Clang20工具链初始化完成！"
          echo "正在去除 dirty 后缀..."
          for f in gki_common/scripts/setlocalversion; do
            sed -i 's/ -dirty//g' "$f"
            sed -i '$i res=$(echo "$res" | sed '\''s/-dirty//g'\'')' "$f"
          done

      # 以下步骤基本保持不变，只修改路径为 gki_common

      - name: 配置ccache目录
        run: |
          echo "CCACHE_DIR=$HOME/.ccache_6.1.118" >> $GITHUB_ENV
          echo "CCACHE_MAXSIZE=3G" >> $GITHUB_ENV

      - name: 载入当前版本内核的 ccache缓存
        uses: actions/cache@v4
        id: ccache-restore
        with:
          path: ${{ env.CCACHE_DIR }}
          key: ccache-gki-6.1.118-${{ runner.os }}-main
          restore-keys: |
            ccache-gki-6.1.118-${{ runner.os }}-
            ccache-gki-6.1.118-

      - name: 初始化并配置ccache
        run: |
          export CCACHE_COMPILERCHECK="none"
          export CCACHE_BASEDIR="${{ github.workspace }}"
          export CCACHE_NOHASHDIR="true"
          export CCACHE_HARDLINK="true"
          export CCACHE_DIR="${{ env.CCACHE_DIR }}"
          export CCACHE_MAXSIZE="${{ env.CCACHE_MAXSIZE }}"
          mkdir -p "$CCACHE_DIR"
          ccache -M "$CCACHE_MAXSIZE"
          ccache -o compression=true
          echo "ccache初始状态:"
          ccache -s

      - name: 添加KernelSU
        id: ksu_version
        run: |
          cd kernel_workspace/gki_common
          # KSU 添加逻辑保持不变（路径调整为当前目录）
          if [[ ${{ github.event.inputs.ksu_type }} == "sukisu" ]]; then
            curl -LSs "https://raw.githubusercontent.com/ShirkNeko/SukiSU-Ultra/refs/heads/main/kernel/setup.sh" | bash -s tmp-builtin
            # 版本处理保持原样...
          # 其他分支保持原样，只改路径
          fi

      - name: 应用 KernelSU & SUSFS 补丁
        if: inputs.susfs_enable
        run: |
          cd kernel_workspace/gki_common
          git clone --depth=1 https://gitlab.com/simonpunk/susfs4ksu.git -b gki-${{ env.ANDROID_VERSION }}-${{ env.KERNEL_VERSION }}
          cp ./susfs4ksu/kernel_patches/50_add_susfs_in_gki-${{ env.ANDROID_VERSION }}-${{ env.KERNEL_VERSION }}.patch ./
          cp -r ./susfs4ksu/kernel_patches/fs/* ./fs/
          cp -r ./susfs4ksu/kernel_patches/include/linux/* ./include/linux/
          patch -p1 < 50_add_susfs_in_gki-${{ env.ANDROID_VERSION }}-${{ env.KERNEL_VERSION }}.patch || true
          # 移除厂商特定补丁（如69_hide_stuff.patch、scope_min_manual_hooks 等）

      - name: 应用lz4 1.10.0 & zstd 1.5.7补丁
        if: inputs.lz4_enable
        run: |
          cd kernel_workspace/gki_common
          # lz4/zstd 补丁通用，可保留（如果有来源）或移除如果不兼容

      - name: 应用 lz4kd 补丁
        if: inputs.lz4kd_enable
        run: |
          cd kernel_workspace/gki_common
          # lz4kd 补丁保持原样

      - name: 添加SUSFS 配置项
        if: inputs.susfs_enable
        run: |
          cd kernel_workspace/gki_common
          echo "CONFIG_KSU_SUSFS=y" >> ./arch/arm64/configs/gki_defconfig
          # 其他 susfs 配置保持

      - name: 添加 KSU & 其他配置项
        run: |
          cd kernel_workspace/gki_common
          echo "CONFIG_KSU=y" >> ./arch/arm64/configs/gki_defconfig
          # kpm、tmpfs 等通用配置保持
          echo "CONFIG_CC_OPTIMIZE_FOR_PERFORMANCE=y" >> ./arch/arm64/configs/gki_defconfig
          echo "CONFIG_HEADERS_INSTALL=n" >> ./arch/arm64/configs/gki_defconfig

      - name: 启用网络功能增强优化配置
        if: inputs.better_net
        run: |
          cd kernel_workspace/gki_common
          # 网络配置通用，保持

      - name: 添加 BBR 等一系列拥塞控制算法
        run: |
          # BBR 等通用，保持

      # 移除三星SSG、Re-Kernel、基带保护等厂商特定步骤

      - name: 添加制作名称
        run: |
          # 保持

      - name: 构建内核
        run: |
          WORKDIR="$(pwd)"
          export PATH="/usr/lib/ccache:$PATH"
          export PATH="$WORKDIR/kernel_workspace/clang20/bin:$PATH"
          export PATH="$WORKDIR/kernel_workspace/build-tools/bin:$PATH"
         
          cd kernel_workspace/gki_common
          # 时间劫持保持
         
          make -j$(nproc --all) LLVM=1 ARCH=arm64 O=out gki_defconfig &&
          make -j$(nproc --all) LLVM=1 ARCH=arm64 O=out Image.lz4

      - name: 应用KPM并修补内核
        run: |
          # 保持（如果启用 kpm）

      - name: 克隆 AnyKernel3 并打包
        run: |
          cd kernel_workspace
          git clone https://github.com/cctv18/AnyKernel3 --depth=1
          rm -rf ./AnyKernel3/.git
          cd AnyKernel3
          cp ../gki_common/out/arch/arm64/boot/Image.lz4 ./Image.lz4  # GKI 用 .lz4
          # zip 打包保持，文件名调整为 GKI

      # 上传和 release 步骤保持不变，调整描述为 “Google 通用 GKI 内核”
  release:
    # 保持，调整 body 描述为 Google 通用 GKI
